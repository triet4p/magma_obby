workflows:
  ios_game_unsigned:
    name: Build iOS Game (Unsigned for Sideloadly)
    max_build_duration: 30
    instance_type: mac_mini_m2

    environment:
      flutter: stable
      xcode: latest
      cocoapods: default

    scripts:
      # ----------------------------------------------------------------
      # 1. SETUP & DEPENDENCIES
      # ----------------------------------------------------------------
      - name: Install dependencies
        script: |
          #!/bin/bash
          set -e
          
          echo "üì¶ Running Flutter pub get..."
          flutter pub get
          
          # N·∫øu b·∫°n ƒë√£ ch·∫°y l·ªánh t·∫°o icon ·ªü local v√† commit assets/icon.png l√™n git
          # th√¨ kh√¥ng c·∫ßn ch·∫°y l·∫°i flutter_launcher_icons ·ªü ƒë√¢y.
          # Nh∆∞ng ch·∫°y d·ª± ph√≤ng c≈©ng kh√¥ng sao.
          echo "üé® Ensuring App Icons are generated..."
          flutter pub run flutter_launcher_icons || true

          echo "üîß Precaching iOS tools..."
          flutter precache --ios

      # ----------------------------------------------------------------
      # 2. HACK PROJECT (QUAN TR·ªåNG NH·∫§T)
      # ----------------------------------------------------------------
      - name: Disable Signing & Configure Xcode Project
        script: |
          #!/bin/bash
          set -e
          
          echo "üèóÔ∏è Generating Xcode project structure..."
          # Ch·∫°y l·ªánh n√†y ƒë·ªÉ Flutter t·∫°o ra folder ios/Runner.xcodeproj
          # N√≥ s·∫Ω fail ·ªü b∆∞·ªõc signing, nh∆∞ng ta ch·ªâ c·∫ßn n√≥ t·∫°o ra file project th√¥i
          flutter build ios --release --no-codesign || true
          
          PBXPROJ="ios/Runner.xcodeproj/project.pbxproj"
          
          if [ -f "$PBXPROJ" ]; then
              echo "üîí Hacking project.pbxproj to remove signing requirements..."
              cp "$PBXPROJ" "$PBXPROJ.backup"
              
              # D√πng sed ƒë·ªÉ x√≥a s·∫°ch c√°c y√™u c·∫ßu Signing trong file c·∫•u h√¨nh Xcode
              # 1. X√≥a Signing Identity
              sed -i '' 's/CODE_SIGN_IDENTITY = .*;/CODE_SIGN_IDENTITY = "";/g' "$PBXPROJ"
              # 2. X√≥a Development Team
              sed -i '' 's/DEVELOPMENT_TEAM = .*;/DEVELOPMENT_TEAM = "";/g' "$PBXPROJ"
              # 3. Chuy·ªÉn Provisioning sang Manual
              sed -i '' 's/ProvisioningStyle = Automatic;/ProvisioningStyle = Manual;/g' "$PBXPROJ"
              # 4. T·∫Øt Bitcode (Game s·∫Ω build nhanh h∆°n v√† nh·∫π h∆°n)
              sed -i '' 's/ENABLE_BITCODE = YES;/ENABLE_BITCODE = NO;/g' "$PBXPROJ"
              
              echo "‚úÖ Code signing disabled successfully!"
          else
              echo "‚ùå Error: project.pbxproj not found!"
              exit 1
          fi

      # ----------------------------------------------------------------
      # 3. BUILD ARCHIVE (UNSIGNED)
      # ----------------------------------------------------------------
      - name: Build XCArchive via xcodebuild
        script: |
          #!/bin/bash
          set -e
          
          cd ios
          
          echo "üîÑ Updating Pods (Flame engines need this)..."
          pod repo update --silent
          pod install
          
          echo "üöÄ Building Runner.xcarchive..."
          # L·ªánh build native √©p bu·ªôc kh√¥ng k√Ω (No Sign)
          xcodebuild \
            -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphoneos \
            -archivePath ../build/Runner.xcarchive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            DEVELOPMENT_TEAM="" \
            ENABLE_BITCODE=NO \
            COMPILER_INDEX_STORE_ENABLE=NO \
            archive
          
          cd ..

      # ----------------------------------------------------------------
      # 4. PACKAGE IPA (MANUAL PAYLOAD)
      # ----------------------------------------------------------------
      - name: Package Payload into IPA
        script: |
          #!/bin/bash
          set -e
          
          # ƒê∆∞·ªùng d·∫´n file app sau khi archive
          APP_PATH="build/Runner.xcarchive/Products/Applications/Runner.app"
          
          if [ ! -d "$APP_PATH" ]; then
              echo "‚ùå Error: Runner.app not found. Build failed."
              exit 1
          fi
          
          echo "üì¶ Packaging IPA manually for Sideloadly..."
          cd build/Runner.xcarchive/Products/Applications
          
          # T·∫°o c·∫•u tr√∫c chu·∫©n c·ªßa file IPA: Folder Payload ch·ª©a file .app
          mkdir -p Payload
          cp -r Runner.app Payload/
          
          # Zip l·∫°i th√†nh .ipa
          # Flag -r: Recursive (th∆∞ m·ª•c con)
          # Flag -y: Gi·ªØ nguy√™n Symlinks (R·∫•t quan tr·ªçng v·ªõi Frameworks c·ªßa Game)
          zip -r -y Runner_Unsigned.ipa Payload/
          
          # Di chuy·ªÉn ra ngo√†i ƒë·ªÉ Artifacts l·∫•y ƒë∆∞·ª£c
          mv Runner_Unsigned.ipa ../../../../Runner_Unsigned.ipa
          
          echo "üéâ IPA Created: Runner_Unsigned.ipa"

    # ----------------------------------------------------------------
    # 5. OUTPUT
    # ----------------------------------------------------------------
    artifacts:
      - Runner_Unsigned.ipa